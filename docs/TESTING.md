# Тестирование модуля jtcsv

## Обзор

Модуль jtcsv теперь включает комплексные тесты для обеспечения качества и безопасности. Тесты покрывают:

- ✅ Основную функциональность конвертации JSON в CSV
- ✅ Обработку ошибок и валидацию входных данных
- ✅ Защиту от уязвимостей (CSV injection, path traversal)
- ✅ Обработку циклических ссылок и сложных структур данных
- ✅ Функцию сохранения в файл с проверкой безопасности

## Запуск тестов

### Установка зависимостей

```bash
npm install
```

### Запуск всех тестов

```bash
npm test
```

### Запуск тестов с покрытием

```bash
npm run test:coverage
```

### Запуск тестов в режиме наблюдения

```bash
npm run test:watch
```

## Структура тестов

### `__tests__/critical-bugs.test.js`
Тесты для критических багов, обнаруженных при анализе:

1. **Циклические ссылки в deepUnwrap** - предотвращение бесконечной рекурсии
2. **Потеря данных в preprocessData** - корректная обработка вложенных объектов
3. **CSV Injection уязвимость** - экранирование формул Excel
4. **Path Traversal в saveAsCsv** - валидация путей файлов
5. **Валидация входных данных** - проверка типов и ограничений

### `__tests__/basic-functionality.test.js`
Тесты основной функциональности:

- Конвертация простых JSON структур
- Использование кастомных разделителей
- Переименование заголовков
- Экранирование специальных символов
- Обработка вложенных структур
- Ограничение максимального количества записей

### `__tests__/save-csv-security.test.js`
Тесты безопасности и функции сохранения:

- Валидация путей файлов
- Защита от directory traversal атак
- Проверка расширения .csv
- Интеграционные тесты

## Покрытие кода

Требуемое покрытие кода установлено на уровне 80%:
- Ветки (branches): 80%
- Функции (functions): 80%
- Строки (lines): 80%
- Операторы (statements): 80%

Для просмотра отчета о покрытии:
```bash
npm run test:coverage
```

Отчет будет доступен в директории `coverage/`. Откройте `coverage/lcov-report/index.html` в браузере.

## Добавление новых тестов

При добавлении новой функциональности обязательно добавляйте соответствующие тесты:

1. Создайте тестовый файл в директории `__tests__/`
2. Импортируйте тестируемые функции
3. Опишите тестовые случаи с помощью `describe()` и `test()`
4. Запустите тесты для проверки

## Пример теста

```javascript
describe('Новая функциональность', () => {
  test('должна работать корректно', () => {
    const result = someFunction(input);
    expect(result).toBe(expected);
  });
});
```

## Линтинг

Для проверки стиля кода:
```bash
npm run lint
```

## Проверка безопасности

```bash
npm run security-check
```

## Непрерывная интеграция

Рекомендуется настроить CI/CD для автоматического запуска тестов при каждом коммите. Пример конфигурации для GitHub Actions:

```yaml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '16'
      - run: npm ci
      - run: npm test
      - run: npm run test:coverage
```



